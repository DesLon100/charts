<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Group Index + Top/Bottom Artists</title>

<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

<style>
body{
  margin:0;
  padding:14px;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:transparent;
  color:#111;
}
.wrap{ max-width:645px; margin:0 auto; }

.controls{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
  margin-bottom:10px;
}

input[type="file"], button, select{
  height:40px;
  padding:0 12px;
  border:1px solid #ddd;
  border-radius:10px;
  background:#fff;
  cursor:pointer;
}
button:hover{border-color:#bbb;}

#chart{
  border:1px solid #eee;
  border-radius:14px;
  background:#fff;
  padding:6px;
}

.panel{
  margin-top:12px;
  border:1px solid #eee;
  border-radius:14px;
  padding:12px;
  background:#fff;
}

.small{font-size:12px;color:#555;line-height:1.35;margin:0 0 10px;}

table{ width:100%; border-collapse:collapse; font-size:13px; }
th,td{ padding:8px 6px; border-bottom:1px solid #f0f0f0; }
th{ font-size:12px; color:#666; font-weight:600; text-align:left; }
.right{text-align:right;}

.toggle{
  height:30px;
  padding:0 10px;
  border-radius:999px;
  border:1px solid #ddd;
  background:#fff;
  font-size:12px;
  cursor:pointer;
}
.toggle.on{
  border-color:#bbb;
  font-weight:600;
}

.muted{ color:#777; }

.list-toggle button{
  height:32px;
}
.list-toggle button.active{
  font-weight:600;
  border-color:#aaa;
}
</style>
</head>

<body>
<div class="wrap">

<div class="controls">
  <input id="file" type="file" accept=".csv" />
  <button id="btnLog" disabled>Log scale: off</button>

  <select id="smoothK" disabled>
    <option value="1">Extra smoothing: off</option>
    <option value="3" selected>Extra smoothing: 3</option>
    <option value="4">Extra smoothing: 4</option>
    <option value="5">Extra smoothing: 5</option>
    <option value="6">Extra smoothing: 6</option>
  </select>

  <button id="btnReset" disabled>Reset</button>
</div>

<div id="chart"></div>

<div class="panel">

<p class="small">
Table ranks artists by their <b>latest 12-month UMV (£)</b>.
Switch between <b>Top 5</b> and <b>Bottom 5</b>.  
Use toggles to overlay individual rebased lines.
</p>

<div class="controls list-toggle">
  <button id="btnTopList" disabled class="active">Top 5</button>
  <button id="btnBottomList" disabled>Bottom 5</button>
</div>

<div id="table"><div class="muted">Upload a CSV to begin.</div></div>

</div>
</div>

<script>

/* ================== parsing ================== */
function parseCSV(text){
  const lines = text.replace(/\r/g,'').split('\n').filter(l=>l.trim());
  const headers = lines[0].split(',').map(h=>h.trim());

  const idxA = headers.findIndex(h=>/^artistid$/i.test(h));
  const idxName = headers.findIndex(h=>/^artistname$/i.test(h));
  const idxM = headers.findIndex(h=>/^monthyyyymm$/i.test(h));
  const idxV = headers.findIndex(h=>/^valuegbp$/i.test(h));

  const rows=[];
  const names=new Map();

  for(let i=1;i<lines.length;i++){
    const p=lines[i].split(',');

    const artist=parseInt(p[idxA],10);
    const month=parseInt(p[idxM],10);
    const value=parseFloat(p[idxV]);

    if(!Number.isFinite(artist)||!Number.isFinite(month)||!Number.isFinite(value)) continue;

    const nm = idxName!==-1 ? (p[idxName]||'').trim() : '';
    if(nm && !names.has(artist)) names.set(artist,nm);

    rows.push({artist,month,value});
  }
  return {rows,names};
}

/* ================== helpers ================== */
function nextMonth(m){ const y=Math.floor(m/100),mm=m%100; return mm===12?(y+1)*100+1:y*100+(mm+1); }
function buildSpine(min,max){ const s=[];let c=min;while(c<=max){s.push(c);c=nextMonth(c);}return s;}
function monthToDate(m){ return new Date(Date.UTC(Math.floor(m/100),(m%100)-1,1)); }
function locf(spine,map){ let last=null;return spine.map(m=>{ if(map.has(m))last=map.get(m); return last; }); }
function rollingMean(arr,w){ return arr.map((_,i)=>{let sum=0,count=0;for(let j=Math.max(0,i-w+1);j<=i;j++){if(Number.isFinite(arr[j])){sum+=arr[j];count++;}}return count?sum/count:null;}); }
function rebase1976(spine,arr){ const idx=spine.indexOf(197601); if(idx===-1)return arr.map(()=>null); const base=arr[idx]; if(!base)return arr.map(()=>null); return arr.map(v=>Number.isFinite(v)?(v/base)*1000:null);}
function rebaseFirst(arr){ let base=arr.find(v=>Number.isFinite(v)); if(!base)return arr.map(()=>null); return arr.map(v=>Number.isFinite(v)?(v/base)*1000:null); }

/* ================== state ================== */
let RAW=null,NAMES=new Map(),GROUP=null;
let TOP5=null,BOTTOM5=null;
let VISIBLE=new Set();
let LIST_MODE='top';
let IS_LOG=false;
let SMOOTH_K=3;

/* ================== computations ================== */
function computeGroup(rows){
  const sc=new Map();
  rows.forEach(r=>{
    let o=sc.get(r.month)||{sum:0,count:0};
    o.sum+=r.value;o.count++;
    sc.set(r.month,o);
  });
  const months=[...sc.keys()].sort((a,b)=>a-b);
  const spine=buildSpine(months[0],months[months.length-1]);
  const avg=new Map([...sc.entries()].map(([m,o])=>[m,o.sum/o.count]));
  let umv=rollingMean(locf(spine,avg),12);
  if(SMOOTH_K>1) umv=rollingMean(umv,SMOOTH_K);
  return {spine,idx:rebase1976(spine,umv)};
}

function computeArtistUMV(rows,id){
  const sc=new Map();
  rows.forEach(r=>{
    if(r.artist!==id)return;
    let o=sc.get(r.month)||{sum:0,count:0};
    o.sum+=r.value;o.count++;
    sc.set(r.month,o);
  });
  const months=[...sc.keys()].sort((a,b)=>a-b);
  if(!months.length)return null;
  const spine=buildSpine(months[0],months[months.length-1]);
  const avg=new Map([...sc.entries()].map(([m,o])=>[m,o.sum/o.count]));
  let umv=rollingMean(locf(spine,avg),12);
  if(SMOOTH_K>1) umv=rollingMean(umv,SMOOTH_K);
  return {spine,umv};
}

function rankArtists(rows,names,asc=false){
  const ids=[...new Set(rows.map(r=>r.artist))];
  const ranked=[];
  ids.forEach(id=>{
    const obj=computeArtistUMV(rows,id);
    if(!obj)return;
    const latest=obj.umv[obj.umv.length-1];
    if(!Number.isFinite(latest))return;
    ranked.push({id,name:names.get(id)||`Artist ${id}`,latest,obj});
  });
  ranked.sort((a,b)=>asc?(a.latest-b.latest):(b.latest-a.latest));
  return ranked.slice(0,5);
}

/* ================== plotting ================== */
function buildTraces(){
  const traces=[{
    x:GROUP.spine.map(monthToDate),
    y:GROUP.idx,
    type:'scatter',
    mode:'lines',
    line:{width:3},
    name:'Group Index'
  }];

  const ACTIVE=(LIST_MODE==='top'?TOP5:BOTTOM5)||[];

  ACTIVE.forEach(r=>{
    if(!VISIBLE.has(r.id))return;
    traces.push({
      x:r.obj.spine.map(monthToDate),
      y:rebaseFirst(r.obj.umv),
      type:'scatter',
      mode:'lines',
      opacity:0.85,
      line:{width:2},
      name:r.name
    });
  });

  return traces;
}

function plot(){
  Plotly.react('chart',buildTraces(),{
    height:430,
    margin:{l:65,r:20,t:20,b:60},
    xaxis:{tickformat:'%Y'},
    yaxis:{title:'Index',type:IS_LOG?'log':'linear'},
    legend:{orientation:'h',y:-0.25}
  },{responsive:true,displayModeBar:false});
}

/* ================== table ================== */
function renderTable(){
  const ACTIVE=(LIST_MODE==='top'?TOP5:BOTTOM5);
  if(!ACTIVE)return;

  let html=`<table><thead>
  <tr><th>Toggle</th><th>Artist</th><th class="right">Latest UMV (£)</th></tr>
  </thead><tbody>`;

  ACTIVE.forEach(r=>{
    const on=VISIBLE.has(r.id);
    html+=`<tr>
      <td><button class="toggle ${on?'on':''}" data-id="${r.id}">${on?'On':'Off'}</button></td>
      <td>${r.name}</td>
      <td class="right">${Math.round(r.latest).toLocaleString()}</td>
    </tr>`;
  });

  html+='</tbody></table>';
  document.getElementById('table').innerHTML=html;

  document.querySelectorAll('.toggle').forEach(btn=>{
    btn.onclick=()=>{
      const id=parseInt(btn.dataset.id);
      VISIBLE.has(id)?VISIBLE.delete(id):VISIBLE.add(id);
      renderTable();
      plot();
    };
  });
}

/* ================== UI wiring ================== */
const fileEl=document.getElementById('file');
const btnLog=document.getElementById('btnLog');
const smoothSel=document.getElementById('smoothK');
const btnReset=document.getElementById('btnReset');
const btnTop=document.getElementById('btnTopList');
const btnBottom=document.getElementById('btnBottomList');

fileEl.onchange=async e=>{
  const f=e.target.files?.[0]; if(!f)return;
  const parsed=parseCSV(await f.text());
  RAW=parsed.rows; NAMES=parsed.names;
  SMOOTH_K=parseInt(smoothSel.value);
  GROUP=computeGroup(RAW);
  TOP5=rankArtists(RAW,NAMES,false);
  BOTTOM5=rankArtists(RAW,NAMES,true);
  VISIBLE=new Set();
  LIST_MODE='top';
  btnTop.classList.add('active'); btnBottom.classList.remove('active');
  plot(); renderTable();
  btnLog.disabled=smoothSel.disabled=btnReset.disabled=false;
  btnTop.disabled=btnBottom.disabled=false;
};

btnLog.onclick=()=>{IS_LOG=!IS_LOG;btnLog.textContent=IS_LOG?'Log scale: on':'Log scale: off';plot();};

smoothSel.onchange=()=>{
  SMOOTH_K=parseInt(smoothSel.value);
  GROUP=computeGroup(RAW);
  TOP5=rankArtists(RAW,NAMES,false);
  BOTTOM5=rankArtists(RAW,NAMES,true);
  VISIBLE=new Set();
  plot(); renderTable();
};

btnTop.onclick=()=>{
  LIST_MODE='top';
  VISIBLE=new Set();
  btnTop.classList.add('active');
  btnBottom.classList.remove('active');
  renderTable(); plot();
};

btnBottom.onclick=()=>{
  LIST_MODE='bottom';
  VISIBLE=new Set();
  btnBottom.classList.add('active');
  btnTop.classList.remove('active');
  renderTable(); plot();
};

btnReset.onclick=()=>{
  RAW=null;GROUP=null;TOP5=null;BOTTOM5=null;
  VISIBLE=new Set();IS_LOG=false;SMOOTH_K=3;
  btnLog.textContent='Log scale: off';
  smoothSel.value='3';
  Plotly.purge('chart');
  document.getElementById('table').innerHTML='<div class="muted">Upload a CSV to begin.</div>';
  btnLog.disabled=smoothSel.disabled=btnReset.disabled=true;
  btnTop.disabled=btnBottom.disabled=true;
  fileEl.value='';
};

</script>
</body>
</html>
