<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Group Index + Top 3 Artists</title>

<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

<style>
body{
  margin:0;
  padding:14px;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:transparent;
}

.wrap{
  max-width:645px;
  margin:0 auto;
}

.controls{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
  margin-bottom:10px;
}

input[type="file"], button, select{
  height:40px;
  padding:0 12px;
  border:1px solid #ddd;
  border-radius:10px;
  background:#fff;
  cursor:pointer;
}

button:hover{border-color:#bbb;}

#chart{
  border:1px solid #eee;
  border-radius:14px;
  background:#fff;
  padding:6px;
}

.panel{
  margin-top:12px;
  border:1px solid #eee;
  border-radius:14px;
  padding:12px;
  background:#fff;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  padding:8px 6px;
  border-bottom:1px solid #f0f0f0;
}
.right{text-align:right;}
.small{font-size:12px;color:#555;}
</style>
</head>

<body>
<div class="wrap">

<div class="controls">
  <input id="file" type="file" accept=".csv" />
  <button id="btnTop" disabled>Show top 3 by value</button>
  <button id="btnLog" disabled>Log scale: off</button>
  <select id="smoothK" disabled>
    <option value="1">Extra smoothing: off</option>
    <option value="3" selected>Extra smoothing: 3</option>
    <option value="4">Extra smoothing: 4</option>
    <option value="5">Extra smoothing: 5</option>
    <option value="6">Extra smoothing: 6</option>
  </select>
  <button id="btnReset" disabled>Reset</button>
</div>

<div id="chart"></div>

<div class="panel">
  <div class="small">
    Ranking uses each artist’s latest 12-month UMV (monthly avg → LOCF → 12M).
    Extra smoothing applies a second rolling average of length k to both group and artist UMVs.
  </div>
  <div id="table"></div>
</div>

</div>

<script>

/* ------------------ UTILITIES ------------------ */

function parseCSV(text){
  const lines=text.replace(/\r/g,'').split('\n').filter(l=>l.trim());
  const headers=lines[0].split(',').map(h=>h.trim());
  const idxA=headers.findIndex(h=>/^artistid$/i.test(h));
  const idxM=headers.findIndex(h=>/^monthyyyymm$/i.test(h)||/^month$/i.test(h));
  const idxV=headers.findIndex(h=>/^valuegbp$/i.test(h)||/^data$/i.test(h));

  const rows=[];
  for(let i=1;i<lines.length;i++){
    const p=lines[i].split(',');
    const artist=parseInt(p[idxA],10);
    const month=parseInt(p[idxM],10);
    const value=parseFloat(p[idxV]);
    if(Number.isFinite(artist)&&Number.isFinite(month)&&Number.isFinite(value)){
      rows.push({artist,month,value});
    }
  }
  return rows;
}

function nextMonth(m){
  const y=Math.floor(m/100);
  const mm=m%100;
  return mm===12?(y+1)*100+1:y*100+mm+1;
}

function buildSpine(min,max){
  const s=[];let c=min;
  while(c<=max){s.push(c);c=nextMonth(c);}
  return s;
}

function locf(spine,map){
  const out=[];let last=null;
  for(const m of spine){
    if(map.has(m)) last=map.get(m);
    out.push(last);
  }
  return out;
}

function rollingMean(arr,w){
  const out=[];
  for(let i=0;i<arr.length;i++){
    let sum=0,count=0;
    for(let j=Math.max(0,i-w+1);j<=i;j++){
      if(Number.isFinite(arr[j])){sum+=arr[j];count++;}
    }
    out.push(count?sum/count:null);
  }
  return out;
}

function rebaseFirst(arr){
  let base=null;
  for(const v of arr){if(Number.isFinite(v)){base=v;break;}}
  if(!base) return arr.map(()=>null);
  return arr.map(v=>Number.isFinite(v)?(v/base)*1000:null);
}

function rebase1976(spine,arr){
  const idx=spine.indexOf(197601);
  if(idx===-1||!arr[idx]) return arr.map(()=>null);
  const base=arr[idx];
  return arr.map(v=>Number.isFinite(v)?(v/base)*1000:null);
}

function monthToDate(m){
  return new Date(Date.UTC(Math.floor(m/100),(m%100)-1,1));
}

/* ------------------ CORE ------------------ */

let SMOOTH_K=3;

function computeGroup(rows){
  const map=new Map();
  for(const r of rows){
    if(!map.has(r.month)) map.set(r.month,{sum:0,count:0});
    const o=map.get(r.month);
    o.sum+=r.value;o.count++;
  }
  const months=[...map.keys()].sort((a,b)=>a-b);
  const spine=buildSpine(months[0],months[months.length-1]);

  const avg=new Map();
  for(const [m,o] of map.entries()) avg.set(m,o.sum/o.count);

  const filled=locf(spine,avg);
  let umv=rollingMean(filled,12);
  if(SMOOTH_K>1) umv=rollingMean(umv,SMOOTH_K);
  const idx=rebase1976(spine,umv);

  return{spine,idx};
}

function computeArtist(rows,id){
  const r=rows.filter(x=>x.artist===id);
  const map=new Map();
  for(const x of r){
    if(!map.has(x.month)) map.set(x.month,{sum:0,count:0});
    const o=map.get(x.month);
    o.sum+=x.value;o.count++;
  }
  const months=[...map.keys()].sort((a,b)=>a-b);
  const spine=buildSpine(months[0],months[months.length-1]);

  const avg=new Map();
  for(const [m,o] of map.entries()) avg.set(m,o.sum/o.count);

  const filled=locf(spine,avg);
  let umv=rollingMean(filled,12);
  if(SMOOTH_K>1) umv=rollingMean(umv,SMOOTH_K);

  return{spine,umv};
}

function top3(rows){
  const ids=[...new Set(rows.map(r=>r.artist))];
  const list=[];
  for(const id of ids){
    const obj=computeArtist(rows,id);
    const latest=obj.umv[obj.umv.length-1];
    if(Number.isFinite(latest)) list.push({id,latest,obj});
  }
  list.sort((a,b)=>b.latest-a.latest);
  return list.slice(0,3);
}

/* ------------------ PLOT ------------------ */

let RAW=null;
let GROUP=null;
let IS_LOG=false;
let CURRENT_TRACES=null;

function plot(traces){
  CURRENT_TRACES=traces;
  Plotly.react("chart",traces,{
    height:650,
    margin:{l:65,r:20,t:20,b:60},
    yaxis:{
      title:"Index",
      type:IS_LOG?"log":"linear"
    },
    showlegend:true,
    legend:{orientation:"h",y:-0.25}
  },{responsive:true,displayModeBar:false});
}

/* ------------------ UI ------------------ */

const fileEl=document.getElementById("file");
const btnTop=document.getElementById("btnTop");
const btnLog=document.getElementById("btnLog");
const btnReset=document.getElementById("btnReset");
const smoothSelect=document.getElementById("smoothK");
const table=document.getElementById("table");

fileEl.addEventListener("change",async e=>{
  const text=await e.target.files[0].text();
  RAW=parseCSV(text);
  GROUP=computeGroup(RAW);
  plot([{
    x:GROUP.spine.map(monthToDate),
    y:GROUP.idx,
    type:"scatter",
    mode:"lines",
    line:{width:3},
    name:"Group Index"
  }]);
  btnTop.disabled=false;
  btnLog.disabled=false;
  btnReset.disabled=false;
  smoothSelect.disabled=false;
});

btnTop.addEventListener("click",()=>{
  const top=top3(RAW);
  const traces=[{
    x:GROUP.spine.map(monthToDate),
    y:GROUP.idx,
    type:"scatter",
    mode:"lines",
    line:{width:3},
    name:"Group Index"
  }];

  let html="<table><thead><tr><th>ArtistID</th><th class='right'>Latest UMV (£)</th></tr></thead><tbody>";

  for(const t of top){
    const rebased=rebaseFirst(t.obj.umv);
    traces.push({
      x:t.obj.spine.map(monthToDate),
      y:rebased,
      type:"scatter",
      mode:"lines",
      line:{width:2},
      name:"Artist "+t.id
    });
    html+=`<tr><td>${t.id}</td><td class='right'>${Math.round(t.latest).toLocaleString()}</td></tr>`;
  }
  html+="</tbody></table>";
  table.innerHTML=html;

  plot(traces);
});

btnLog.addEventListener("click",()=>{
  IS_LOG=!IS_LOG;
  btnLog.textContent=IS_LOG?"Log scale: on":"Log scale: off";
  if(CURRENT_TRACES) plot(CURRENT_TRACES);
});

smoothSelect.addEventListener("change",()=>{
  SMOOTH_K=parseInt(smoothSelect.value,10);
  if(RAW){
    GROUP=computeGroup(RAW);
    plot([{
      x:GROUP.spine.map(monthToDate),
      y:GROUP.idx,
      type:"scatter",
      mode:"lines",
      line:{width:3},
      name:"Group Index"
    }]);
  }
});

btnReset.addEventListener("click",()=>{
  RAW=null;GROUP=null;IS_LOG=false;SMOOTH_K=3;
  btnTop.disabled=true;
  btnLog.disabled=true;
  btnReset.disabled=true;
  smoothSelect.disabled=true;
  btnLog.textContent="Log scale: off";
  smoothSelect.value="3";
  Plotly.purge("chart");
  table.innerHTML="";
});

</script>
</body>
</html>
