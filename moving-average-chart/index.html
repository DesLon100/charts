<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Monthly Moving Average</title>

<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

<style>
body {
  margin: 0;
  padding: 14px;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: transparent;
}
.wrap { max-width: 645px; }
.controls { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
button, select {
  height: 40px;
  border-radius: 10px;
  border: 1px solid #ccc;
  background: #fff;
  padding: 0 12px;
  font-size: 14px;
}
#chart { width: 100%; height: 360px; }
.hint { font-size: 12px; color: #666; margin-top: 6px; }
</style>
</head>

<body>
<div class="wrap">

  <div class="controls">
    <input type="file" id="fileInput" accept=".csv">
    <select id="windowSelect">
      <option value="12">12-month avg</option>
      <option value="24">24-month avg</option>
      <option value="36">36-month avg</option>
    </select>
  </div>

  <div id="chart"></div>
  <div class="hint">CSV format: Column A = YYYYMM, Column B = Value</div>

</div>

<script>
const fileInput = document.getElementById("fileInput");
const windowSelect = document.getElementById("windowSelect");

let monthly = [];

fileInput.addEventListener("change", async () => {
  const file = fileInput.files[0];
  if (!file) return;

  const text = await file.text();
  const rows = text.trim().split(/\r?\n/).map(r => r.split(","));

  monthly = rows
    .map(r => {
      const s = (r[0] || "").replace(/\D/g, "");
      if (s.length !== 6) return null;
      const y = +s.slice(0,4);
      const m = +s.slice(4,6);
      const v = parseFloat((r[1] || "").replace(/,/g,""));
      if (!v) return null;
      return {
        date: new Date(Date.UTC(y, m-1, 1)),
        value: v
      };
    })
    .filter(Boolean)
    .sort((a,b)=>a.date-b.date);

  draw();
});

windowSelect.addEventListener("change", draw);

function trailingAvg(data, n) {
  return data.map((d,i)=>{
    const slice = data.slice(Math.max(0,i-n+1), i+1);
    return {
      date: d.date,
      value: slice.reduce((s,x)=>s+x.value,0)/slice.length
    };
  });
}

function draw() {
  if (!monthly.length) return;

  const n = +windowSelect.value;
  const ma = trailingAvg(monthly, n);

  Plotly.newPlot("chart", [{
    x: ma.map(d=>d.date),
    y: ma.map(d=>d.value),
    mode: "lines",
    line: { width: 2 }
  }], {
    paper_bgcolor: "rgba(0,0,0,0)",
    plot_bgcolor: "rgba(0,0,0,0)",
    margin: { l: 50, r: 10, t: 10, b: 40 },
    yaxis: { tickformat: ",.0f" },
    xaxis: { tickformat: "%Y-%m" }
  }, { displayModeBar: false });
}
</script>

</body>
</html>
