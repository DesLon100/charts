<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Monthly Moving Average</title>

<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

<style>
body {
  margin: 0;
  padding: 14px;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: transparent;
}
.wrap { max-width: 645px; }
.controls { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
button, select {
  height: 40px;
  border-radius: 10px;
  border: 1px solid #ccc;
  background: #fff;
  padding: 0 12px;
  font-size: 14px;
}
#chart { width: 100%; height: 360px; }
.hint { font-size: 12px; color: #666; margin-top: 6px; }
</style>
</head>

<body>
<div class="wrap">

  <div class="controls">
    <input type="file" id="fileInput" accept=".csv">
    <select id="windowSelect">
      <option value="12">12-month avg</option>
      <option value="24">24-month avg</option>
      <option value="36">36-month avg</option>
    </select>
  </div>

  <div id="chart"></div>
  <div class="hint">CSV format: Column A = YYYYMM, Column B = Value</div>

</div>

<script>
const fileInput = document.getElementById("fileInput");
const windowSelect = document.getElementById("windowSelect");

let monthly = [];

const statusEl = document.createElement("div");
statusEl.style.cssText = "margin-top:6px;font-size:12px;background:#fff;padding:6px 10px;border:1px solid #ddd;border-radius:8px;display:none;";
document.querySelector(".wrap").appendChild(statusEl);

function status(msg) {
  statusEl.textContent = msg;
  statusEl.style.display = "block";
}

fileInput.addEventListener("change", async () => {
  const file = fileInput.files[0];
  if (!file) return;

  try {
    const text = await file.text();
    const rows = parseCSV(text);

    monthly = rows
      .map(r => {
        const yyyymm = (r[0] ?? "").toString().replace(/\D/g, "");
        if (yyyymm.length !== 6) return null;

        const y = Number(yyyymm.slice(0,4));
        const m = Number(yyyymm.slice(4,6));
        if (!Number.isInteger(y) || !Number.isInteger(m) || m < 1 || m > 12) return null;

        const v = toNumber(r[1]);
        if (!Number.isFinite(v)) return null;

        return { date: new Date(Date.UTC(y, m - 1, 1)), value: v };
      })
      .filter(Boolean)
      .sort((a,b)=>a.date-b.date);

    if (!monthly.length) {
      status("No valid rows found. Expected Column A = YYYYMM, Column B = Value.");
      Plotly.purge("chart");
      return;
    }

    status(`Loaded ${monthly.length} months. Rendering…`);
    draw();
    setTimeout(() => (statusEl.style.display = "none"), 1500);

  } catch (e) {
    status("Error: " + (e?.message || String(e)));
    Plotly.purge("chart");
  }
});

windowSelect.addEventListener("change", draw);

function toNumber(v) {
  if (typeof v === "number") return v;
  const s = String(v ?? "").trim();
  if (!s) return NaN;
  // remove £, spaces, thousands commas
  const cleaned = s.replace(/£/g, "").replace(/\s/g, "").replace(/,/g, "");
  const n = Number(cleaned);
  return Number.isFinite(n) ? n : NaN;
}

// Proper CSV parser (handles quotes + commas inside quotes)
function parseCSV(text) {
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    const next = text[i + 1];

    if (ch === '"' && inQuotes && next === '"') { cur += '"'; i++; continue; }
    if (ch === '"') { inQuotes = !inQuotes; continue; }

    if (ch === "," && !inQuotes) { row.push(cur); cur = ""; continue; }

    if ((ch === "\n" || ch === "\r") && !inQuotes) {
      if (ch === "\r" && next === "\n") i++;
      row.push(cur); cur = "";
      if (row.some(c => String(c).trim() !== "")) rows.push(row);
      row = [];
      continue;
    }

    cur += ch;
  }

  row.push(cur);
  if (row.some(c => String(c).trim() !== "")) rows.push(row);

  // Drop header row if it looks like one
  if (rows.length && /month/i.test(rows[0][0] || "")) rows.shift();

  return rows;
}

function trailingAvg(data, n) {
  return data.map((d,i)=>{
    const slice = data.slice(Math.max(0,i-n+1), i+1);
    return {
      date: d.date,
      value: slice.reduce((s,x)=>s+x.value,0)/slice.length
    };
  });
}

function draw() {
  if (!monthly.length) return;

  const n = Number(windowSelect.value);
  const ma = trailingAvg(monthly, n);

  Plotly.newPlot("chart", [{
    x: ma.map(d=>d.date),
    y: ma.map(d=>d.value),
    mode: "lines",
    line: { width: 2 }
  }], {
    paper_bgcolor: "rgba(0,0,0,0)",
    plot_bgcolor: "rgba(0,0,0,0)",
    margin: { l: 50, r: 10, t: 10, b: 40 },
    yaxis: { tickformat: ",.0f" },
    xaxis: { tickformat: "%Y-%m" }
  }, { displayModeBar: false, responsive: true });
}
</script>
