<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Monthly Moving Average</title>

<style>
  body{
    margin:0;
    padding:14px;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:transparent;
  }
  .wrap{ max-width:645px; }

  .controls{
    display:flex;
    gap:10px;
    margin-bottom:10px;
    flex-wrap:wrap;
    align-items:center;
  }

  input[type="file"]{ height:40px; background:#fff; }
  select{
    height:40px;
    border-radius:10px;
    border:1px solid #ccc;
    background:#fff;
    padding:0 12px;
    font-size:14px;
  }

  #chart{ width:100%; height:360px; }

  #status{
    margin-top:8px;
    font-size:12px;
    background:#fff;
    padding:8px 10px;
    border:1px solid #ddd;
    border-radius:10px;
    display:none;
    white-space:pre-wrap;
  }
</style>
</head>

<body>
<div class="wrap">

  <div class="controls">
    <input type="file" id="fileInput" accept=".csv">
    <select id="windowSelect">
      <option value="12">12-month avg</option>
      <option value="24">24-month avg</option>
      <option value="36">36-month avg</option>
    </select>
  </div>

  <div id="chart"></div>
  <div id="status"></div>

</div>

<script>
  const fileInput   = document.getElementById("fileInput");
  const windowSelect = document.getElementById("windowSelect");
  const statusEl    = document.getElementById("status");

  function status(msg){
    statusEl.textContent = msg;
    statusEl.style.display = "block";
  }
  function clearStatus(){
    statusEl.textContent = "";
    statusEl.style.display = "none";
  }

  window.addEventListener("error", e => {
    status("JS error:\n" + (e.message || e.type));
  });

  // -------- Plotly loader (with fallback CDNs) --------
  async function loadScript(src){
    return new Promise((resolve, reject) => {
      const s = document.createElement("script");
      s.src = src;
      s.onload = resolve;
      s.onerror = reject;
      document.head.appendChild(s);
    });
  }

  async function ensurePlotly(){
    if (typeof Plotly !== "undefined") return true;

    const cdns = [
      "https://cdn.plot.ly/plotly-2.35.2.min.js",
      "https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.35.2/plotly.min.js",
      "https://unpkg.com/plotly.js-dist-min@2.35.2/plotly.min.js"
    ];

    for (const url of cdns){
      try{
        await loadScript(url);
        if (typeof Plotly !== "undefined") return true;
      } catch(e){}
    }

    status("Plotly failed to load.\nCheck blockers or network policy.");
    return false;
  }

  ensurePlotly();

  let monthlyCalendar = [];

  fileInput.addEventListener("change", async () => {
    const ok = await ensurePlotly();
    if (!ok) return;

    const file = fileInput.files?.[0];
    if (!file) return;

    try{
      const text = await file.text();
      const rows = parseCSV(text);
      monthlyCalendar = buildMonthlyCalendar(rows);

      if (!monthlyCalendar.length){
        Plotly.purge("chart");
        status("No valid rows found.\nExpected: YYYYMM, Value");
        return;
      }

      draw();
      clearStatus();

    } catch(err){
      Plotly.purge("chart");
      status("CSV read error:\n" + err.message);
    }
  });

  windowSelect.addEventListener("change", () => {
    if (!monthlyCalendar.length) return;
    draw();
  });

  // -------- CSV parsing --------
  function parseCSV(text){
    const rows = [];
    let row = [], cur = "", inQuotes = false;

    for (let i=0;i<text.length;i++){
      const ch = text[i], next = text[i+1];
      if (ch === '"' && inQuotes && next === '"'){ cur+='"'; i++; continue; }
      if (ch === '"'){ inQuotes=!inQuotes; continue; }
      if (ch === "," && !inQuotes){ row.push(cur); cur=""; continue; }
      if ((ch==="\n"||ch==="\r")&&!inQuotes){
        if (ch==="\r"&&next==="\n") i++;
        row.push(cur); cur="";
        if (row.some(c=>c.trim()!=="")) rows.push(row);
        row=[];
        continue;
      }
      cur+=ch;
    }
    row.push(cur);
    if (row.some(c=>c.trim()!=="")) rows.push(row);

    if (rows.length && /month/i.test(rows[0][0]||"")) rows.shift();
    return rows;
  }

  function toNumber(v){
    const n = Number(String(v).replace(/[£,\s]/g,""));
    return Number.isFinite(n) ? n : NaN;
  }

  function parseYYYYMM(v){
    const d = String(v).replace(/\D/g,"");
    if (d.length < 6) return null;
    const y = +d.slice(0,4), m = +d.slice(4,6);
    if (m<1||m>12) return null;
    return new Date(Date.UTC(y,m-1,1));
  }

  function addMonthsUTC(d,n){
    return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth()+n, 1));
  }

  function buildMonthlyCalendar(rows){
    const byMonth = new Map();

    for (const r of rows){
      if (r.length<2) continue;
      const d = parseYYYYMM(r[0]);
      const v = toNumber(r[1]);
      if (!d||!isFinite(v)) continue;

      const k = `${d.getUTCFullYear()}-${d.getUTCMonth()}`;
      const cur = byMonth.get(k)||{sum:0,n:0,date:d};
      cur.sum+=v; cur.n++;
      byMonth.set(k,cur);
    }
    if (!byMonth.size) return [];

    const dates = [...byMonth.values()].map(x=>x.date).sort((a,b)=>a-b);
    const out=[];
    for (let d=new Date(dates[0]); d<=dates.at(-1); d=addMonthsUTC(d,1)){
      const k = `${d.getUTCFullYear()}-${d.getUTCMonth()}`;
      const a = byMonth.get(k);
      out.push({date:new Date(d), value:a? a.sum/a.n : 0});
    }
    return out;
  }

  // -------- rolling sums & smoothing --------
  function rollingSums(data,n){
    const out=[], q=[];
    let sum=0;
    for (let i=0;i<data.length;i++){
      sum+=data[i].value;
      q.push(data[i].value);
      if (q.length>n) sum-=q.shift();
      out.push({date:data[i].date, sum:(i>=n-1)?sum:null});
    }
    return out;
  }

  function smooth3(roll,n){
    return roll.map((d,i)=>({
      date:d.date,
      value:(d.sum!=null&&roll[i-1]?.sum!=null&&roll[i-2]?.sum!=null)
        ? (d.sum+roll[i-1].sum+roll[i-2].sum)/(3*n)
        : null
    }));
  }

  function draw(){
    const n = +windowSelect.value;
    const roll = rollingSums(monthlyCalendar,n);
    const smooth = smooth3(roll,n);

    if (!smooth.some(d=>d.value!=null)){
      Plotly.purge("chart");
      status(`Not enough data.\nNeed at least ${n+2} months.`);
      return;
    }

    Plotly.newPlot("chart", [{
      x: smooth.map(d=>d.date),
      y: smooth.map(d=>d.value),
      type:"scatter",
      mode:"lines",
      line:{width:2}
    }],{
      showlegend:false,
      paper_bgcolor:"rgba(0,0,0,0)",
      plot_bgcolor:"rgba(0,0,0,0)",
      margin:{l:75,r:10,t:10,b:45},
      yaxis:{
        title:"GBP",
        tickprefix:"£",
        tickformat:"~s",
        zeroline:false
      },
      xaxis:{
        type:"date",
        tickformat:"%Y",
        dtick:"M60",
        hoverformat:"%Y-%m"
      }
    },{
      displayModeBar:false,
      responsive:true
    });
  }
</script>

</body>
</html>
