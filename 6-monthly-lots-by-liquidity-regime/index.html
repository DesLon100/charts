<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>6-monthly auction lots by liquidity regime</title>

<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

<style>
  body{
    margin:0;
    padding:14px;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:transparent;
  }
  .wrap{ max-width:645px; }

  .controls{
    display:flex;
    gap:10px;
    margin-bottom:10px;
    flex-wrap:wrap;
    align-items:center;
  }

  input[type="file"]{ height:40px; background:#fff; }

  #chart{ width:100%; height:410px; }

  #status{
    margin-top:8px;
    font-size:12px;
    background:#fff;
    padding:8px 10px;
    border:1px solid #ddd;
    border-radius:10px;
    display:none;
    white-space:pre-wrap;
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="controls">
    <input type="file" id="fileInput" accept=".csv,.txt,text/csv,text/plain">
  </div>

  <div id="chart"></div>
  <div id="status"></div>
</div>

<script>
  const fileInput = document.getElementById("fileInput");
  const statusEl  = document.getElementById("status");

  function status(msg){
    statusEl.textContent = msg;
    statusEl.style.display = "block";
  }
  function clearStatus(){
    statusEl.textContent = "";
    statusEl.style.display = "none";
  }

  // Show JS errors on-page (so it's never mysterious)
  window.addEventListener("error", (e) => {
    status("JS error:\n" + (e.message || e.type) + "\n" + (e.filename || "") + ":" + (e.lineno || ""));
  });

  if (typeof Plotly === "undefined") {
    status("Plotly failed to load. Check internet or blocked scripts.");
  } else {
    status("Page loaded. Upload a CSV to render liquidity-regime bands.");
    setTimeout(clearStatus, 1200);
  }

  fileInput.addEventListener("change", async () => {
    clearStatus();
    const file = fileInput.files?.[0];
    if (!file) return;

    try{
      const text = await file.text();
      const parsed = parseTable(text);

      // Validate required columns
      const required = ["period_start","illiquid_2_5","intermediate_6_19","liquid_20_plus"];
      for (const k of required){
        if (!(k in parsed.idx)) throw new Error(`Missing column: ${k}`);
      }

      const x  = [];
      const yI = [];
      const yM = [];
      const yL = [];

      for (const row of parsed.rows){
        // period_start as label: keep as-is, but strip time if present
        let ps = String(row[parsed.idx.period_start] ?? "").trim();
        ps = ps.replace(/T.*$/, "");           // ISO time
        ps = ps.replace(/\s+\d\d:.*$/, "");    // " 00:00:00.000"
        if (!ps) continue;

        const ill = toNumber(row[parsed.idx.illiquid_2_5]);
        const mid = toNumber(row[parsed.idx.intermediate_6_19]);
        const liq = toNumber(row[parsed.idx.liquid_20_plus]);

        x.push(ps);
        yI.push(isFinite(ill) ? ill : 0);
        yM.push(isFinite(mid) ? mid : 0);
        yL.push(isFinite(liq) ? liq : 0);
      }

      if (!x.length){
        Plotly.purge("chart");
        status("No valid rows found.\nExpected columns:\nperiod_start, illiquid_2_5, intermediate_6_19, liquid_20_plus");
        return;
      }

      status(
        `Loaded ${parsed.rows.length} data rows\n` +
        `Plotted ${x.length} half-year periods.\nRendering…`
      );

      draw({ x, yI, yM, yL });
      setTimeout(clearStatus, 1500);

    }catch(err){
      console.error(err);
      Plotly.purge("chart");
      status("Error:\n" + (err?.message || String(err)));
    }
  });

  // Detect delimiter (comma/tab/semicolon) and parse header + rows
  function parseTable(text){
    const clean = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").trim();
    const lines = clean.split("\n").filter(l => l.trim().length);
    if (lines.length < 2) throw new Error("File has no data rows.");

    const headerLine = lines[0];

    const candidates = [",", "\t", ";"];
    let delim = ",";
    let best = -1;
    for (const d of candidates){
      const c = headerLine.split(d).length;
      if (c > best){ best = c; delim = d; }
    }

    const header = headerLine.split(delim).map(s => s.trim());
    const idx = Object.fromEntries(header.map((h,i)=>[h,i]));

    const rows = [];
    for (let i=1; i<lines.length; i++){
      const parts = lines[i].split(delim);
      // pad if short
      while (parts.length < header.length) parts.push("");
      rows.push(parts.map(s => String(s).trim()));
    }

    return { header, idx, rows, delim };
  }

  function toNumber(v){
    const s = String(v ?? "").trim();
    if (!s) return NaN;
    // handle "1,234" and currency symbols
    const cleaned = s.replace(/£/g,"").replace(/\s/g,"").replace(/,/g,"");
    const n = Number(cleaned);
    return Number.isFinite(n) ? n : NaN;
  }

  function draw({ x, yI, yM, yL }){
    const traces = [
      {
        x, y: yI,
        type: "scatter",
        mode: "lines",
        name: "Illiquid (2–5)",
        stackgroup: "one",
        line: { width: 0.5 }
      },
      {
        x, y: yM,
        type: "scatter",
        mode: "lines",
        name: "Intermediate (6–19)",
        stackgroup: "one",
        line: { width: 0.5 }
      },
      {
        x, y: yL,
        type: "scatter",
        mode: "lines",
        name: "Liquid (≥20)",
        stackgroup: "one",
        line: { width: 0.5 }
      }
    ];

    Plotly.newPlot("chart", traces, {
      paper_bgcolor: "rgba(0,0,0,0)",
      plot_bgcolor: "rgba(0,0,0,0)",
      margin: { l: 70, r: 10, t: 60, b: 55 },

      title: {
        text: "6-monthly auction lots by liquidity regime<br>920-artist cohort (since 2009)",
        x: 0.5
      },

      yaxis: {
        title: "Number of lots",
        rangemode: "tozero",
        zeroline: false
      },

      xaxis: {
        title: "Time (bi-annual)",
        tickangle: 0,
        automargin: true
      },

      legend: {
        x: 0.02, y: 0.98,
        bgcolor: "rgba(255,255,255,0.7)",
        bordercolor: "rgba(0,0,0,0.15)",
        borderwidth: 1
      }
    }, {
      displayModeBar: false,
      responsive: true
    });
  }
</script>
</body>
</html>
